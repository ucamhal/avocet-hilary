/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

var _ = require('underscore');
var assert = require('assert');
var Cassandra = require('oae-util/lib/cassandra');
var fs = require('fs');
var util = require('util');

var AuthenticationConstants = require('oae-authentication/lib/constants').AuthenticationConstants;
var AuthenticationDAO = require('oae-authentication/lib/internal/dao');
var AuthzUtil = require('oae-authz/lib/util');
var ConfigTestUtil = require('oae-config/lib/test/util');
var LoginId = require('oae-authentication/lib/model').LoginId;
var RestAPI = require('oae-rest');
var TestsUtil = require('oae-tests/lib/util');

var Publication = require('oae-publications/lib/model').Publication;
var PublicationsAPI = require('oae-publications');
var PublicationsConstants = require('oae-publications/lib/constants').PublicationsConstants;
var PublicationsRestAPI = require('../lib/test/util');

describe('Publications', function() {

    var app = null;
    var server = null;
    var port = null;
    var users = {};

    var camAnonymousRestCtx = null;
    var gtAdminRestCtx = null;
    var camAdminRestCtx = null;
    var globalAdminRestCtx = null;
    var simongRestContext = null;

    /*!
     * Set up a web server that mocks Symplectic responses, cleans out the publications and creates users that can be used
     * to ingest data for.
     */
    before(function(callback) {
        camAnonymousRestCtx = TestsUtil.createTenantRestContext(global.oaeTests.tenants.cam.host);
        gtAdminRestCtx = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.gt.host);
        camAdminRestCtx = TestsUtil.createTenantAdminRestContext(global.oaeTests.tenants.cam.host);
        globalAdminRestCtx = TestsUtil.createGlobalAdminRestContext();

        TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, simong) {
            assert.ok(!err);
            assert.ok(simong);
            simongRestContext = simong.restContext;
            return callback();
        });
    });

    /**
     * Generates a random source Id
     *
     * @return {String} A random string that can be used as a source id
     */
    var generateRandomSourceId = function() {
        return 'mendeley#' + TestsUtil.generateRandomText();
    };

    /**
     * Utility method that returns a stream that points to a PDF
     *
     * @return {Stream}     A stream that points to a PDF that can be uploaded
     */
    var getFileStream = function() {
        var file = __dirname + '/data/paper.pdf';
        return fs.createReadStream(file);
    };

    /**
     * Creates a test user and `nrOfPublications` publications for that user.
     *
     * @param  {Number}             nrOfPublications            Number of publications that should be created
     * @param  {Function}           callback                    Standard callback method
     * @param  {Object}             callback.user               The created user
     * @param  {Publication[]}      callback.publications       A set of publications that have been created, these will be sorted descending on their publication date
     */
    var createUserWithPublications = function(nrOfPublications, callback) {
        TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, createdUser) {
            assert.ok(!err);

            var publications = [];

            /*!
             * Can be used to sort an array of publications
             */
            var sortByDate = function(a, b) {
                return b.date - a.date;
            };

            /*!
             * After all the publications have been created
             */
            var _finishCreatingPublications = function() {
                return callback(createdUser, publications);
            };

            /*!
             * Create a new publication and link it with our test user
             */
            var _createPublications = function() {
                if (nrOfPublications === 0) {
                    return _finishCreatingPublications();
                }

                var yearInMilliSeconds = 365 * 24 * 60 * 60 * 1000;
                var publishedDate = 1000000000000 + (Math.floor(Math.random() * yearInMilliSeconds) - yearInMilliSeconds/2);
                PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName', 'journal article', publishedDate, [createdUser.user.displayName], null, null, function(err, data) {
                    assert.ok(!err);
                    publications.push(data.publication);
                    publications = publications.sort(sortByDate);

                    PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, createdUser.user.displayName, createdUser.user.id, function(err) {
                        assert.ok(!err);
                        nrOfPublications--;
                        return _createPublications();
                    });
                });
            };

            _createPublications();
        });
    };

    describe('#createPublication()', function() {

        /**
         * Test that verifies that the parameters are validated
         */
        it('verify parameter validation', function(callback) {

            // Invalid publication permutations
            PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], null, 'journal article', 1388676959000, ['an author'], null, null, function(err, data) {
                assert.equal(err.code, 400);
                PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', null, 1388676959000, ['an author'], null, null, function(err) {
                    assert.equal(err.code, 400);
                    PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'unknown publication type', 1388676959000, ['an author'], null, null, function(err) {
                        assert.equal(err.code, 400);
                        PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'journal article', null, ['an author'], null, null, function(err) {
                            assert.equal(err.code, 400);
                            PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'journal article', 'not a date', ['an author'], null, null, function(err) {
                                assert.equal(err.code, 400);
                                PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'journal article', 1388676959000, null, null, null, function(err) {
                                    assert.equal(err.code, 400);
                                    PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'journal article', 1388676959000, {}, null, null, function(err) {
                                        assert.equal(err.code, 400);
                                        PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'journal article', 1388676959000, [], null, null, function(err) {
                                            assert.equal(err.code, 400);

                                            // Invalid source permutations
                                            PublicationsRestAPI.createPublication(camAdminRestCtx, null, 'displayName', 'journal article', 1388676959000, ['an author'], null, null, function(err) {
                                                assert.equal(err.code, 400);
                                                PublicationsRestAPI.createPublication(camAdminRestCtx, {}, 'displayName', 'journal article', 1388676959000, ['an author'], null, null, function(err) {
                                                    assert.equal(err.code, 400);
                                                    PublicationsRestAPI.createPublication(camAdminRestCtx, [], 'displayName', 'journal article', 1388676959000, ['an author'], null, null, function(err) {
                                                        assert.equal(err.code, 400);
                                                        PublicationsRestAPI.createPublication(camAdminRestCtx, ['not a source id'], 'displayName', 'journal article', 1388676959000, ['an author'], null, null, function(err) {
                                                            assert.equal(err.code, 400);

                                                            // Sanity check
                                                            PublicationsRestAPI.createPublication(camAdminRestCtx, ['wos#1234'], 'displayName', 'journal article', 1388676959000, ['an author'], null, null, function(err) {
                                                                assert.ok(!err);
                                                                return callback();
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies the user's permissions
         */
        it('verify permissions', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, simong) {
                assert.ok(!err);

                PublicationsRestAPI.createPublication(camAnonymousRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['Author from A'], null, null, function(err, dataA) {
                    assert.equal(err.code, 401);
                    PublicationsRestAPI.createPublication(simong.restContext, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['Author from A'], null, null, function(err, dataA) {
                        assert.ok(!err);

                        // Admins can always create publications
                        PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['Author from A'], null, null, function(err, dataA) {
                            assert.ok(!err);
                            RestAPI.Admin.loginOnTenant(TestsUtil.createGlobalAdminRestContext(), 'localhost', null, function(err, ctx) {
                                assert.ok(!err);
                                PublicationsRestAPI.createPublication(ctx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['Author from A'], null, null, function(err, dataA) {
                                    assert.ok(!err);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that all the parameters are passed in correctly
         */
        it('verify extra parameters', function(callback) {
            var extra = {
                'openAccessType': 'green',
                'journalName': 'the journal name',
                'issueNumber': '1',
                'pageBegin': '10',
                'pageEnd': '11',
                'funders': ['funder a', 'funder b', 'funder c', 'other:funder a', 'other:funder b'],
                'department': 'the department',
                'contactEmail': 'contact@mail.com',
                'useCambridgeAddendum': 'true',
                'comments': 'Lorem ipsum dolor sit amet',
                'acceptanceDate': 5008135
            };

            // Create a new publication
            PublicationsRestAPI.createPublication(camAdminRestCtx, [generateRandomSourceId], 'displayName', 'journal article', 1388676959000, ['an author'], extra, getFileStream, function(err, data) {
                assert.ok(!err);
                assert.ok(data.publication);

                // Get the full publication
                PublicationsRestAPI.getPublication(camAdminRestCtx, data.publication.id, function(err, publication) {
                    assert.ok(!err);
                    assert.ok(publication);
                    assert.strictEqual(publication.openAccessType, extra.openAccessType);
                    assert.strictEqual(publication.journalName, extra.journalName);
                    assert.strictEqual(publication.issueNumber, extra.issueNumber);
                    assert.strictEqual(publication.pageBegin, extra.pageBegin);
                    assert.strictEqual(publication.pageEnd, extra.pageEnd);
                    assert.equal(publication.funders.length, 5);
                    _.each(publication.funders, function(funder) {
                        assert.ok(_.contains(extra.funders, funder));
                    });
                    assert.strictEqual(publication.department, extra.department);
                    assert.strictEqual(publication.contactEmail, extra.contactEmail);
                    assert.strictEqual(publication.useCambridgeAddendum, extra.useCambridgeAddendum);
                    assert.strictEqual(publication.comments, extra.comments);
                    assert.strictEqual(publication.acceptanceDate, extra.acceptanceDate);

                    extra = {
                        'openAccessType': 'gold',
                        'journalName': 'journal name',
                        'issueNumber': '3',
                        'pageBegin': '21',
                        'pageEnd': '22',
                        'funders': ['other:funder a', 'other:funder b', 'funder c', 'funder d', 'funder d'],
                        'department': 'some department',
                        'contactEmail': 'administrator@mail.com',
                        'useCambridgeAddendum': 'false',
                        'comments': 'An unanswered door is a happy door',
                        'acceptanceDate': 1015
                    };

                    // Create a new publication
                    PublicationsRestAPI.createPublication(camAdminRestCtx, [generateRandomSourceId], 'Some publication', 'journal article', 1388676959000, ['an author'], extra, getFileStream, function(err, data) {
                        assert.ok(!err);
                        assert.ok(data.publication);

                        // Get the full publication
                        PublicationsRestAPI.getPublication(camAdminRestCtx, data.publication.id, function(err, publication) {
                            assert.ok(!err);
                            assert.ok(publication);
                            assert.strictEqual(publication.openAccessType, extra.openAccessType);
                            assert.strictEqual(publication.journalName, extra.journalName);
                            assert.strictEqual(publication.issueNumber, extra.issueNumber);
                            assert.strictEqual(publication.pageBegin, extra.pageBegin);
                            assert.strictEqual(publication.pageEnd, extra.pageEnd);
                            assert.equal(publication.funders.length, 4);
                            _.each(publication.funders, function(funder) {
                                assert.ok(_.contains(extra.funders, funder));
                            });
                            assert.strictEqual(publication.department, extra.department);
                            assert.strictEqual(publication.contactEmail, extra.contactEmail);
                            assert.strictEqual(publication.useCambridgeAddendum, extra.useCambridgeAddendum);
                            assert.strictEqual(publication.comments, extra.comments);
                            assert.strictEqual(publication.acceptanceDate, extra.acceptanceDate);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that if you ingest a publication with a source that's already in the system, it will not result in another record but the source will simply be added to the list of sources for that publication
         */
        it('verify ingesting a publication with an already seen source results in an update', function(callback) {
            var ids = [ generateRandomSourceId(), generateRandomSourceId(), generateRandomSourceId() ];
            var sourceIdsA = [ids[0], ids[1]];
            var sourceIdsB = [ids[1], ids[2]];
            PublicationsRestAPI.createPublication(camAdminRestCtx, sourceIdsA, 'displayName A', 'journal article', 1388676959000, ['Author from A'], null, null, function(err, dataA) {
                assert.ok(!err);
                assert.equal(dataA.result, PublicationsConstants.ingestionResult.CREATED);

                // Because we have the same source as a source from A, we'll "update" the publication record
                PublicationsRestAPI.createPublication(camAdminRestCtx, sourceIdsA, 'displayName B', 'journal article', 1388676959000, ['Author from B'], null, null, function(err, dataB) {
                    assert.ok(!err);
                    assert.equal(dataB.result, PublicationsConstants.ingestionResult.UPDATED);
                    assert.equal(dataA.publication.id, dataB.publication.id);

                    // Get the full publication
                    PublicationsRestAPI.getPublication(camAdminRestCtx, dataA.publication.id, function(err, publication) {
                        assert.ok(!err);

                        // Verify only one author returns
                        assert.equal(publication.displayName, 'displayName B');
                        assert.equal(publication.authors.length, 1);
                        assert.equal(publication.authors[0], 'Author from A');
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that the data that gets sent in the creation request is actually persisted
         */
        it('verify functionality', function(callback) {

            var extra = {
                'issueNumber': '12',
                'pageBegin': '42',
                'pageEnd': '47'
            };

            PublicationsRestAPI.createPublication(camAdminRestCtx, [generateRandomSourceId()], 'A displayName', 'journal article', 1388676959000, ['An author'], extra, null, function(err, data) {
                assert.ok(!err);

                // Get the full publication and asser that all the data is returned
                PublicationsRestAPI.getPublication(camAdminRestCtx, data.publication.id, function(err, publication) {
                    assert.ok(!err);
                    assert.equal(publication.displayName, 'A displayName');
                    assert.equal(publication.publicationType, 'journal article');
                    assert.equal(publication.date, 1388676959000);
                    assert.equal(publication.authors.length, 1);
                    assert.equal(publication.authors[0], 'An author');
                    assert.equal(publication.issueNumber, '12');
                    assert.equal(publication.pageBegin, '42');
                    assert.equal(publication.pageEnd, '47');
                    return callback();
                });
            });
        });

        /**
         * Test that verifies that when creating a publication, the uploaded resource is successfully linked
         */
        it('verify attaching a resource while creating a publication is successful', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);
                assert.ok(users);
                assert.ok(coenego);

                // Create a new publication
                var date = 1388676959000;
                var authors = [coenego.user.id];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data.publication);
                    assert.equal(data.publication.displayName, 'displayName A');
                    assert.equal(data.publication.date, date);
                    assert.equal(data.publication.authors.length, authors.length);
                    assert.equal(data.publication.authors[0].id, authors[0]);
                    assert.ok(data.result);
                    assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                    return callback();
                });
            });
        });
    });

    describe('#linkPublicationToUser()', function() {

        /**
         * Test that verifies that the parameters are validated
         */
        it('verify parameter validation', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, simong) {

                // Create a new publication
                PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['someAuthor'], null, null, function(err, data) {
                    assert.ok(!err);

                    // Invalid publication id permutation
                    PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, 'not a publicationId', 'someAuthor', simong.user.id, function(err) {
                        assert.equal(err.code, 400);

                        // Invalid author
                        PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, null, simong.user.id, function(err) {
                            assert.equal(err.code, 400);

                            // Invalid user id
                            PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, 'someAuthor', null, function(err) {
                                assert.equal(err.code, 400);
                                PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, 'someAuthor', 'not a user', function(err) {
                                    assert.equal(err.code, 400);

                                    // Sanity check
                                    PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, 'someAuthor', simong.user.id, function(err) {
                                        assert.ok(!err);
                                        return callback();
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies only authorized users can link publications
         */
        it('verify permissions', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 2, function(err, users, simong, mrvisser) {
                PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['authorA', 'authorB'], null, null, function(err, data) {
                    assert.ok(!err);

                    PublicationsRestAPI.linkPublicationToUser(camAnonymousRestCtx, data.publication.id, 'authorA', simong.user.id, function(err) {
                        assert.equal(err.code, 401);
                        PublicationsRestAPI.linkPublicationToUser(simong.restContext, data.publication.id, 'authorA', simong.user.id, function(err) {
                            assert.ok(!err);

                            // Administrators can always link publications
                            PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, 'authorA', simong.user.id, function(err) {
                                assert.ok(!err);
                                RestAPI.Admin.loginOnTenant(TestsUtil.createGlobalAdminRestContext(), 'localhost', null, function(err, ctx) {
                                    assert.ok(!err);
                                    PublicationsRestAPI.linkPublicationToUser(ctx, data.publication.id, 'authorB', mrvisser.user.id, function(err) {
                                        assert.ok(!err);
                                        // Double-check both admins actually linked their users
                                        PublicationsRestAPI.getPublication(camAnonymousRestCtx, data.publication.id, function(err, publication) {
                                            assert.ok(!err);
                                            assert.equal(publication.authors.length, 2);
                                            _.each(publication.authors, function(author) {
                                                assert.ok(typeof author !== 'string');
                                                assert.ok(_.contains([simong.user.id, mrvisser.user.id], author.id));
                                            });

                                            PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['authorA', 'authorB'], null, null, function(err, data) {
                                                assert.ok(!err);
                                                // Anonymous users can never link publications
                                                PublicationsRestAPI.linkPublicationToUser(camAnonymousRestCtx, data.publication.id, 'authorA', simong.user.id, function(err) {
                                                    assert.equal(err.code, 401);
                                                    // Authenticated users can only link themselves
                                                    PublicationsRestAPI.linkPublicationToUser(simong.restContext, data.publication.id, 'authorA', mrvisser.user.id, function(err) {
                                                        assert.equal(err.code, 401);
                                                        PublicationsRestAPI.linkPublicationToUser(simong.restContext, data.publication.id, 'authorA', simong.user.id, function(err) {
                                                            assert.ok(!err);
                                                            PublicationsRestAPI.getPublication(camAnonymousRestCtx, data.publication.id, function(err, publication) {
                                                                assert.ok(!err);
                                                                assert.equal(publication.authors.length, 2);
                                                                assert.ok(_.find(publication.authors, function(author) { return author.id === simong.user.id; }));
                                                                assert.ok(_.find(publication.authors, function(author) { return author === 'authorB'; }));
                                                                return callback();
                                                            });
                                                        });
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies you cannot link a user twice
         */
        it('verify users cannot be linked twice', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 2, function(err, users, simong, mrvisser) {
                assert.ok(!err);
                assert.ok(users);

                // Create a new publication
                PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['authorA', 'authorB'], null, null, function(err, data) {
                    assert.ok(!err);

                    PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, 'authorA', simong.user.id, function(err, linkData) {
                        assert.ok(!err);
                        assert.equal(linkData.result, PublicationsConstants.linkResult.LINKED);

                        PublicationsRestAPI.linkPublicationToUser(camAdminRestCtx, data.publication.id, 'authorA', simong.user.id, function(err, linkData) {
                            assert.ok(!err);
                            assert.equal(linkData.result, PublicationsConstants.linkResult.PRESENT);

                            PublicationsRestAPI.getPublication(camAnonymousRestCtx, data.publication.id, function(err, publication) {
                                assert.ok(!err);
                                assert.equal(publication.authors.length, 2);

                                // 'authorA' should not have been replaced
                                assert.equal(_.filter(publication.authors, function(author) { return (typeof author === 'string'); }).length, 1);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that registered OAE users can be linked to a publication
         */
        it('verify linking authors with registered oae users', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);
                assert.ok(users);
                assert.ok(coenego);

                // Create a new publication
                PublicationsRestAPI.createPublication(camAdminRestCtx, [ generateRandomSourceId() ], 'displayName A', 'journal article', 1388676959000, ['authorA', coenego.user.id], null, null, function(err, data) {
                    assert.ok(!err);
                    assert.strictEqual(data.publication.authors.length, 2);
                    assert.strictEqual(data.publication.authors[0], 'authorA');
                    assert.strictEqual(data.publication.authors[1].id, coenego.user.id);
                    assert.strictEqual(data.publication.displayName, 'displayName A');

                    PublicationsRestAPI.getPublication(camAnonymousRestCtx, data.publication.id, function(err, publication) {
                        assert.ok(!err);
                        assert.ok(_.isString(publication.authors[0]));
                        assert.strictEqual(publication.authors[0], 'authorA');
                        assert.ok(_.isObject(publication.authors[1]));
                        assert.strictEqual(publication.authors[1].id, coenego.user.id);
                        assert.strictEqual(publication.authors[1].displayName, coenego.user.displayName);
                        return callback();
                    });
                });
            });
        });
    });

    describe('#getPublication()', function() {

        /**
         * Test that verifies that the parameters are validated
         */
        it('verify parameter validation', function(callback) {
            createUserWithPublications(1, function(simong, createdPublications) {

                // Malformed user ID
                PublicationsRestAPI.getPublication(simong.restContext, 'Not a publication ID', function(err, data) {
                    assert.equal(err.code, 400);

                    // Sanity check
                    PublicationsRestAPI.getPublication(simong.restContext, createdPublications[0].id, function(err, publication) {
                        assert.ok(!err);
                        assert.equal(publication.date, createdPublications[0].date);
                        assert.equal(publication.displayName, createdPublications[0].displayName);
                        assert.equal(publication.publicationType, createdPublications[0].publicationType);
                        assert.equal(publication.publisher, createdPublications[0].publisher);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that the content profile has been added to the publication
         */
        it('verify that the content profile is added to the publication profile', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);

                // Create a new publication
                var date = 1388676959000;
                var authors = ['random user A', coenego.user.id, 'random user B'];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data.publication);
                    var createdPublication = data.publication;

                    // Sanity check
                    PublicationsRestAPI.getPublication(coenego.restContext, createdPublication.id, function(err, publication) {
                        assert.ok(!err);
                        assert.equal(publication.id, createdPublication.id);
                        assert.equal(publication.displayName, createdPublication.displayName);
                        assert.equal(publication.createdBy, createdPublication.createdBy);
                        assert.ok(publication.linkedContent);
                        assert.equal(publication.linkedContent.displayName, createdPublication.displayName);
                        return callback();
                    });
                });
            });
        });
    });

    describe('#getPublicationsByAuthor()', function() {

        /**
         * Test that verifies that the parameters are validated
         */
        it('verify parameter validation', function(callback) {
            createUserWithPublications(30, function(simong, createdPublications) {

                // Malformed user ID
                PublicationsRestAPI.getPublications(simong.restContext, 'not a user id', null, 3, function(err, data) {
                    assert.equal(err.code, 400);

                    // 10 is the default and 25 is the maximum amount of publications that should be returned from the REST api
                    PublicationsRestAPI.getPublications(simong.restContext, simong.user.id, null, null, function(err, data) {
                        assert.ok(!err);
                        assert.equal(data.results.length, 10);
                        PublicationsRestAPI.getPublications(simong.restContext, simong.user.id, null, 50, function(err, data) {
                            assert.ok(!err);
                            assert.equal(data.results.length, 25);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that the content profile is added to the publication object if a file has been uploaded
         */
        it('verify content profile added to publication', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);

                // Create a new publication
                var date = 1388676959000;
                var authors = ['random user A', coenego.user.id, 'random user B'];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data.publication);
                    var createdPublication = data.publication;

                    // Request the created publication
                    PublicationsRestAPI.getPublications(coenego.restContext, coenego.user.id, null, 50, function(err, data) {
                        assert.ok(!err);
                        assert.ok(data);
                        assert.ok(data.results);
                        assert.equal(data.results.length, 1);
                        assert.equal(data.results[0].id, createdPublication.id);
                        assert.equal(data.results[0].displayName, createdPublication.displayName);
                        assert.equal(data.results[0].publicationType, createdPublication.publicationType);
                        assert.equal(data.results[0].date, createdPublication.date);
                        assert.ok(data.results[0].linkedContent);
                        assert.equal(data.results[0].linkedContent.id, createdPublication.linkedContentId);
                        assert.equal(data.results[0].linkedContent.displayName, createdPublication.displayName);
                        assert.equal(data.results[0].linkedContent.createdBy, coenego.user.id);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies a user their publications are ordered on the publication date and can be paged
         */
        it('verify ordering and paging', function(callback) {
            createUserWithPublications(8, function(simong, createdPublications) {

                // Get the first 3 publications
                PublicationsRestAPI.getPublications(simong.restContext, simong.user.id, null, 3, function(err, data) {
                    assert.ok(!err);

                    assert.equal(data.results.length, 3);
                    assert.equal(data.results[0].id, createdPublications[0].id);
                    assert.equal(data.results[1].id, createdPublications[1].id);
                    assert.equal(data.results[2].id, createdPublications[2].id);

                    // Get the next 3 publications
                    PublicationsRestAPI.getPublications(simong.restContext, simong.user.id, data.nextToken, 3, function(err, data) {
                        assert.ok(!err);

                        assert.equal(data.results.length, 3);
                        assert.equal(data.results[0].id, createdPublications[3].id);
                        assert.equal(data.results[1].id, createdPublications[4].id);
                        assert.equal(data.results[2].id, createdPublications[5].id);

                        // Get the last 2 publications
                        PublicationsRestAPI.getPublications(simong.restContext, simong.user.id, data.nextToken, 3, function(err, data) {
                            assert.ok(!err);

                            assert.equal(data.results.length, 2);
                            assert.equal(data.results[0].id, createdPublications[6].id);
                            assert.equal(data.results[1].id, createdPublications[7].id);
                            return callback();
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that a user is linked to the publication in which he was tagged as an author
         */
        it('verify a user is linked to the publication in which he was tagged as an author', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);
                assert.ok(coenego);

                // Create a new publication
                var date = Date.now();
                var authors = ['random user A', coenego.user.id, 'random user B'];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.equal(data.publication.createdBy, coenego.user.id);
                    assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                    var createdPublication = data.publication;

                    // Check if the coenego user has been linked to the publication
                    PublicationsRestAPI.getPublications(coenego.restContext, coenego.user.id, null, null, function(err, data) {
                        assert.ok(!err);
                        assert.ok(data);
                        assert.equal(data.results.length, 1);
                        assert.equal(data.results[0].id, createdPublication.id);
                        assert.equal(data.results[0].authors.length, authors.length);
                        assert.equal(data.results[0].createdBy, createdPublication.createdBy);
                        assert.equal(data.results[0].date, createdPublication.date);
                        assert.equal(data.results[0].displayName, createdPublication.displayName);
                        assert.equal(data.results[0].publicationType, createdPublication.publicationType);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that the correct publications are returned when a user is tagged in multiple publications
         */
        it('verify that the correct publications are returned when a user is tagged in multiple publications', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);

                // Create a new publication
                var date = Date.now();
                var authors = [coenego.user.id];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.equal(data.publication.createdBy, coenego.user.id);
                    assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                    var createdPublication1 = data.publication;

                    date = Date.now();
                    authors = [coenego.user.id];
                    PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName B', 'book', date, authors, null, getFileStream, function(err, data) {
                        assert.ok(!err);
                        assert.equal(data.publication.createdBy, coenego.user.id);
                        assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                        var createdPublication2 = data.publication;

                        // Check if the coenego user has been linked to the publication
                        PublicationsRestAPI.getPublications(coenego.restContext, coenego.user.id, null, null, function(err, data) {
                            assert.ok(!err);
                            assert.ok(data);
                            assert.equal(data.results.length, 2);

                            // Reverse the publications collection
                            data.results = data.results.reverse();

                            // Check the first publication
                            assert.equal(data.results[0].id, createdPublication1.id);
                            assert.equal(data.results[0].authors.length, createdPublication1.authors.length);
                            assert.equal(data.results[0].createdBy, createdPublication1.createdBy);
                            assert.equal(data.results[0].date, createdPublication1.date);
                            assert.equal(data.results[0].displayName, createdPublication1.displayName);
                            assert.equal(data.results[0].publicationType, createdPublication1.publicationType);

                            // Check the second publication
                            assert.equal(data.results[1].id, createdPublication2.id);
                            assert.equal(data.results[1].authors.length, createdPublication2.authors.length);
                            assert.equal(data.results[1].createdBy, createdPublication2.createdBy);
                            assert.equal(data.results[1].date, createdPublication2.date);
                            assert.equal(data.results[1].displayName, createdPublication2.displayName);
                            assert.equal(data.results[1].publicationType, createdPublication2.publicationType);
                            return callback();
                        });
                    });
                });
            });
        });
    });

    describe('#getPublicationsByCreator()', function() {

        /**
         * Test that verifies that a user is linked the the publication he created
         */
        it('verify a user is linked to the publication he created', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);

                // Create a new publication
                var date = Date.now();
                var authors = ['random user A', coenego.user.id];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.equal(data.publication.createdBy, coenego.user.id);
                    assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                    var createdPublication = data.publication;

                    // Check if the coenego user has been linked to the publication
                    PublicationsRestAPI.getPublicationsByCreator(coenego.restContext, coenego.user.id, null, null, function(err, data) {
                        assert.ok(!err);
                        assert.ok(data);
                        assert.equal(data.results.length, 1);
                        assert.equal(data.results[0].id, createdPublication.id);
                        assert.equal(data.results[0].authors.length, authors.length);
                        assert.equal(data.results[0].createdBy, createdPublication.createdBy);
                        assert.equal(data.results[0].date, createdPublication.date);
                        assert.equal(data.results[0].displayName, createdPublication.displayName);
                        assert.equal(data.results[0].publicationType, createdPublication.publicationType);
                        return callback();
                    });
                });
            });
        });

        /**
         * Test that verifies that the correct publications are returned when creating multiple ones with the same user
         */
        it('verify that the correct publications are returned when creating multiple ones with the same user', function(callback) {
            TestsUtil.generateTestUsers(camAdminRestCtx, 1, function(err, users, coenego) {
                assert.ok(!err);
                assert.ok(coenego);

                // Create a new publication
                var date = Date.now();
                var authors = ['random user A'];
                PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName A', 'journal article', date, authors, null, getFileStream, function(err, data) {
                    assert.ok(!err);
                    assert.equal(data.publication.createdBy, coenego.user.id);
                    assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                    var createdPublication1 = data.publication;

                    date = Date.now();
                    authors = ['random User B'];
                    PublicationsRestAPI.createPublication(coenego.restContext, [generateRandomSourceId()], 'displayName B', 'book', date, authors, null, getFileStream, function(err, data) {
                        assert.ok(!err);
                        assert.equal(data.publication.createdBy, coenego.user.id);
                        assert.equal(data.result, PublicationsConstants.ingestionResult.CREATED);
                        var createdPublication2 = data.publication;

                        // Check if the coenego user has been linked to the publication
                        PublicationsRestAPI.getPublicationsByCreator(coenego.restContext, coenego.user.id, null, null, function(err, data) {
                            assert.ok(!err);
                            assert.ok(data);
                            assert.equal(data.results.length, 2);
                            return callback();
                        });
                    });
                });
            });
        });
    });

    describe('#updatePublication()', function(callback) {

        /**
         * Test that verifies that the parameters are validated
         */
        it('verify parameter validation', function(callback) {
            createUserWithPublications(1, function(coenego, createdPublications) {
                assert.ok(createdPublications);

                // Malformed publication ID
                PublicationsRestAPI.updatePublication(coenego.restContext, 'Not a publication ID', {}, function(err, data) {
                    assert.equal(err.code, 400);

                    // Malformed fields
                    PublicationsRestAPI.updatePublication(coenego.restContext, createdPublications[0].id, {}, function(err, data) {
                        assert.equal(err.code, 400);

                        // Malformed fields
                        PublicationsRestAPI.updatePublication(coenego.restContext, createdPublications[0].id, [], function(err, data) {
                            assert.equal(err.code, 400);

                            // Wellformed fields
                            var fields = {'displayName': 'A displayName'};
                            PublicationsRestAPI.updatePublication(coenego.restContext, createdPublications[0].id, fields, function(err, data) {
                                assert.ok(!err);
                                return callback();
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies that only authorized users can update a publication
         */
        it('verify permissions', function(callback) {
            createUserWithPublications(1, function(coenego, createdPublications) {
                assert.ok(createdPublications);

                // Update the publication with an anoymous user
                var fields = {'displayName': 'A displayName'};
                PublicationsRestAPI.updatePublication(camAnonymousRestCtx, createdPublications[0].id, fields, function(err, data) {
                    assert.equal(err.code, 401);

                    // Update the publication with an GT admin
                    PublicationsRestAPI.updatePublication(gtAdminRestCtx, createdPublications[0].id, fields, function(err, data) {
                        assert.equal(err.code, 401);

                        // Update the publication with the Simong user
                        PublicationsRestAPI.updatePublication(simongRestContext, createdPublications[0].id, fields, function(err, data) {
                            assert.equal(err.code, 401);

                            // Update the publication with the Coenego user
                            PublicationsRestAPI.updatePublication(coenego.restContext, createdPublications[0].id, fields, function(err, data) {
                                assert.ok(!err);

                                // Update the publication with a Cam admin
                                PublicationsRestAPI.updatePublication(camAdminRestCtx, createdPublications[0].id, fields, function(err, data) {
                                    assert.ok(!err);
                                    return callback();
                                });
                            });
                        });
                    });
                });
            });
        });

        /**
         * Test that verifies a publication can be updated successfully
         */
        it('verify updating a publication is successful', function(callback) {
            createUserWithPublications(1, function(coenego, createdPublications) {
                assert.ok(createdPublications);

                // Update the publication with a Cam admin
                var fields = {'displayName': 'An unopened door is a happy door'};
                PublicationsRestAPI.updatePublication(coenego.restContext, createdPublications[0].id, fields, function(err, data) {
                    assert.ok(!err);
                    assert.ok(data.publication);
                    assert.strictEqual(data.publication.id, createdPublications[0].id);
                    assert.strictEqual(data.publication.displayName, 'An unopened door is a happy door');
                    assert.strictEqual(data.result, PublicationsConstants.ingestionResult.UPDATED);

                    // Update the publication with a Cam admin
                    var fields = {'displayName': 'Some exotic display name'};
                    PublicationsRestAPI.updatePublication(camAdminRestCtx, createdPublications[0].id, fields, function(err, data) {
                        assert.ok(!err);
                        assert.ok(data.publication);
                        assert.strictEqual(data.publication.id, createdPublications[0].id);
                        assert.strictEqual(data.publication.displayName, 'Some exotic display name');
                        assert.strictEqual(data.result, PublicationsConstants.ingestionResult.UPDATED);
                        return callback();
                    });
                });
            });
        });
    });
});
